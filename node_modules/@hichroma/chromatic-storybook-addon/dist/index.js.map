{"version":3,"sources":["../src/index.js"],"names":["process","env","CHROMATIC_INDEX_URL","specsQuery","appCode","storiesOf","getStorybook","addons","Components","client","networkInterface","uri","watchQuery","query","variables","pollInterval","observable","subscribe","error","console","next","data","log","components","appByCode","forEach","name","specs","chapter","id","input","add","parsedInput","JSON","parse","ancestors","dimensions","element","inputToElement","wrapInAncestors","forceRerender","fullStorybook","dumpedStorybook","map","kind","stories","channel","getChannel","emit","childrenToElements","props","childToElement","child","$text","childProps","children","Component","Error","width","height","style","margin","padding","position","reduceRight","output","Tag","className"],"mappings":"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","file":"index.js","sourcesContent":["import React from 'react';\n\nimport 'babel-polyfill';\n\nimport ApolloClient, { createNetworkInterface } from 'apollo-client';\nimport gql from 'graphql-tag';\n\nconst { CHROMATIC_INDEX_URL = 'http://chromatic-index.hichroma.com/graphql' } = process.env;\n\n// XXX: do this\n// import { storiesOf } from '@storybook/react';\n\nconst specsQuery = gql`\n  query specsQuery($appCode: String!) {\n    appByCode(code: $appCode) {\n      components {\n        name\n        specs {\n          id\n          input\n        }\n      }\n    }\n  }\n`;\n\nexport default async function(appCode, { storiesOf, getStorybook, addons, Components }) {\n  const client = new ApolloClient({\n    networkInterface: createNetworkInterface({ uri: CHROMATIC_INDEX_URL }),\n  });\n\n  const observable = await client.watchQuery({\n    query: specsQuery,\n    variables: { appCode },\n    pollInterval: 1000,\n  });\n\n  observable.subscribe({\n    error(error) {\n      console.error(error);\n    },\n    next({ data }) {\n      console.log(data);\n      const { appByCode: { components } } = data;\n      components.forEach(({ name, specs }) => {\n        const chapter = storiesOf(name);\n        specs.forEach(({ id, input }) =>\n          chapter.add(id, () => {\n            const parsedInput = JSON.parse(input);\n            const { ancestors, dimensions } = parsedInput;\n            const element = inputToElement(parsedInput, Components);\n            return wrapInAncestors(element, ancestors, dimensions);\n          })\n        );\n      });\n      // eslint-disable-next-line no-use-before-define\n      forceRerender({ getStorybook, addons });\n    },\n  });\n}\n\nfunction forceRerender({ getStorybook, addons }) {\n  // Force a re-render\n  const fullStorybook = getStorybook();\n  // This is what the output of story_store.dumpStorybook looks like:\n  const dumpedStorybook = fullStorybook.map(({ kind, stories }) => ({\n    kind,\n    stories: stories.map(({ name }) => name),\n  }));\n  const channel = addons.getChannel();\n  channel.emit('setStories', { stories: dumpedStorybook });\n}\n\n// XXX: copied from isolator, refactor\nfunction childrenToElements(props, Components) {\n  const childToElement = child => {\n    if (typeof child === 'string') {\n      return child;\n    }\n\n    if (child.$text) {\n      return child.$text;\n    }\n\n    // It will be a basic DOM element\n    const childProps = childrenToElements(child.props, Components);\n    return <child.name {...childProps} />;\n  };\n\n  return {\n    ...props,\n    children: props.children ? props.children.map(childToElement) : [],\n  };\n}\n\nfunction inputToElement({ name, props }, Components) {\n  console.log({ name, props });\n  const Component = Components[name];\n  if (!Component) {\n    console.error(`Didn't find component named ${name}!`);\n    console.error(`Our components are: ${Object.keys(Components)}`);\n    throw new Error(`Didn't find ${name}`);\n  }\n  return <Component {...childrenToElements(props, Components)} />;\n}\n\nfunction wrapInAncestors(element, ancestors, { width, height }) {\n  const style = {\n    width,\n    height,\n    margin: 0,\n    padding: 0,\n    position: 'static',\n  };\n  return ancestors.reduceRight(\n    (output, { name: Tag, id, className }) =>\n      <Tag id={id} className={className} style={style}>\n        {output}\n      </Tag>,\n    element\n  );\n}\n"]}